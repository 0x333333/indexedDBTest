<!DOCTYPE html>
<html>
  <head>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
    <script type="text/javascript" src="IndexedDBShim/dist/IndexedDBShim.min.js"></script>
    <script type="text/javascript">

    var db, store;
    
    function startTests(){

      addEventListeners();

      if (typeof window.mozIndexedDB !== "undefined") {
        window.indexedDB = window.mozIndexedDB;
      }
      else {
        window.indexedDB = window.shimIndexedDB;
        window.shimIndexedDB.__useShim();
        window.shimIndexedDB.__debug(true);
        console.log("Starting Tests with shimIndexedDB");
      }

      // window.indexedDB = window.indexedDB || window.mozIndexedDB || window.webkitIndexedDB || window.msIndexedDB || window.shimIndexedDB;

      // Create database
      var dbOpenRequest = window.indexedDB.open('library');

      dbOpenRequest.onsuccess = function(e){
        console.log("Database Opened successfully");
        db = dbOpenRequest.result;
      };
      
      dbOpenRequest.onupgradeneeded = function(e){
        console.log("Database Upgraded successfully");
        db = dbOpenRequest.result;
        store = db.createObjectStore('books', {
          keyPath: "isbn",
          "autoIncrement": false
        });

        var isbnIndex = store.createIndex("by_isbn", "isbn", {unique: true});
        var titleIndex = store.createIndex("by_title", "title");
        var authorIndex = store.createIndex("by_author", "author");

        store.put({title: "Quarry Memories", author: "Fred", isbn: 123456});
        store.put({title: "Water Buffaloes", author: "Fred", isbn: 234567});
        store.put({title: "Bedrock Nights", author: "Barney", isbn: 345678});

      };
    }

    function loadData() {
      var tx = db.transaction('books', 'readwrite');
      store = tx.objectStore('books');

      var request;
      try {
        var obj = {title: randomChar(30), author: randomChar(8), isbn: Math.floor(Math.random()*1000000)};
        request = store.put(obj);
      } catch (e) {
        throw e;
      }

      request.onsuccess = function (event) {
        showAll();
        console.log("Insertion in DB successful");
      };
    }

    function showAll() {
      console.log('Show all data');

      // bind data list html tag
      var record_list = $('#data-list');
      record_list.empty();

      var tx = db.transaction('books', 'readwrite');
      store = tx.objectStore("books");

      var request = store.count();
      request.onsuccess = function(event) {
        console.log('There are ' + event.target.result +
                    ' record(s) in the object store.');
      };

      // get cursor in order to look up all these records
      request = store.openCursor();
      request.onsuccess = function(event) {
        var cursor = event.target.result;
        // If there are record(s)
        if (cursor) {
          // console.log("displayAll cursor:", cursor);
          request = store.get(cursor.key);
          request.onsuccess = function (event) {
            var value = event.target.result;
            // console.log(value);
            var list_item = $('<li>' +
                                '[' + cursor.key + '] ' +
                                '<strong>' + value.title + '</strong>, ' +
                                value.author +
                              '</li>');

            record_list.append(list_item);
          };
          // Move on to the next object in store
          cursor.continue();
          // This counter serves only to create distinct ids
        } else {
          console.log("No more entries");
        }
      };
    }

    function deleteAll() {
      console.log('Delete all data');
      var tx = db.transaction('books', 'readwrite');
      store = tx.objectStore('books');

      var request = store.clear();

      request.onsuccess = function(event) {
        // display list
        console.log('Data clear successfully.');
      };
    }

    function deleteByISBN(id) {
      console.log('Delete by ISBN');
      var tx = db.transaction('books', 'readwrite');
      store = tx.objectStore('books');

      var request = store.delete(parseInt(id));
      request.onsuccess = function(event) {
        showAll();
        console.log('Delete successfully.');
      };
    }



    function randomChar(l) {
      var x=" qwert yuio plk jhg fds azxcv bnm ";
      var tmp="";
      for(var i=0; i<l; i++) {
        tmp += x.charAt(Math.ceil(Math.random()*100000000)%x.length);
      }
      return tmp;
    }

    function addEventListeners() {
      console.log('addEventListeners');

      $('#add-button').click(function(event) {
        loadData();
      });

      $('#all-button').click(function(event) {
        showAll();
      });

      $('#clear-button').click(function(event) {
        deleteAll();
      });

      $('#delete-button').click(function(event) {
        var id = $('#id-to-delete').val();
        deleteByISBN(id);
      });

    }

    </script>
  </head>
  <body onload="startTests()">

    <input type="button" id="add-button" value="Load data" />
    <input type="button" id="all-button" value="Show all data" />
    <input type="button" id="clear-button" value="Delete all data" />
    <input type="text" id="id-to-delete" placeholder="id to delete" />
    <input type="button" id="delete-button" value="Delete by isbn" />

    <form id="register-form">
      <table>
        <tbody>
          <tr>
            <td>
              <label for="pub-title" class="required">
                Title:
              </label>
            </td>
            <td>
              <input type="text" id="pub-title" name="pub-title" />
            </td>
          </tr>
          <tr>
            <td>
              <label for="pub-id" class="required">
                ID:<br/>
              </label>
            </td>
            <td>
              <input type="text" id="pub-id" name="pub-id"/>
            </td>
          </tr>
        </tbody>
      </table>
      <div class="button-pane">
        <input type="button" id="add-button" value="Add Publication" />
      </div>
    </form>

    <hr/>

    <form id="delete-form">
      <table>
        <tbody>
          <tr>
            <td>
              <label for="pub-id-to-delete">
                ID:<br/>
              </label>
            </td>
            <td>
              <input type="text" id="pub-id-to-delete" name="pub-id-to-delete" />
            </td>
          </tr>
          <tr>
            <td>
              <label for="key-to-delete">
                Key:<br/>
                <span class="note">(for example 1, 2, 3, etc.)</span>
              </label>
            </td>
            <td>
              <input type="text" id="key-to-delete"
              name="key-to-delete" />
            </td>
          </tr>
        </tbody>
      </table>
      <div class="button-pane">
        <input type="button" id="delete-button" value="Delete Publication" />
        <input type="button" id="clear-store-button"
        value="Clear the whole store" class="destructive" />
      </div>
    </form>

    <hr/>

    <form id="search-form">
      <div class="button-pane">
        <input type="button" id="show-list-button"
        value="List database content" />
      </div>
    </form>

    <hr/>
    
    <div>
      <ul id="data-list">
      </ul>
    </div>


  </body>
</html>